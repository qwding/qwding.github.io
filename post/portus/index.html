<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# website: http://ogp.me/ns/website#">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <meta name="description" content="contrast hugo with hexo">
    <meta property="og:title" content="portus的docker容器搭建">
    
    <meta property="og:type" content="article">
    <meta property="article:published_time" content="2016-04-20">
    
    <meta property="og:description" content="contrast hugo with hexo">
    <meta property="og:url" content="http://blog.qwding.com/post/portus/">
    <meta property="og:site_name" content="qwding的blog">
    
    <meta property="og:tags" content="portus">
    
    <meta property="og:tags" content="registry">
    
    <meta name="generator" content="Hugo 0.15" />
    <title>portus的docker容器搭建 &middot; qwding的blog</title>
    
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css">
    
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/styles/default.min.css">
    
    <link rel="stylesheet" href="http://blog.qwding.com/css/style.css">
    <link href="" rel="alternate" type="application/rss+xml" title="qwding的blog" />

    
    
</head>
<body>
<nav class="navbar navbar-default navbar-fixed-top visible-xs">
	<div class="container-fluid">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
				<a class="navbar-brand" href="http://blog.qwding.com/">Qwding</a>
			
		</div>
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				
				
					<li><a href="http://blog.qwding.com/about">About</a></li>
				
					<li><a href="http://blog.qwding.com/post/">Blog</a></li>
				
					<li><a href="http://blog.qwding.com/persional/">Persional</a></li>
				
					<li><a href="http://blog.qwding.com/relax/">Relax</a></li>
				
			</ul>
		</div>
	</div>
</nav>
<div class="container-fluid">
	<div class="row">
		<div id="menu" class="hidden-xs col-sm-4 col-md-3">
	<div id="menu-content" class="vertical-align">
		
			<h1 class="text-center"><a href="http://blog.qwding.com/">Qwding</a></h1>
		
		
		
			<small class="text-center center-block">安逸是福</small>
		
		
		
			<img id="profile-pic" src="http://blog.qwding.com//img/dog.jpeg" alt="My Picture" class="img-circle center-block">
		
		<div id="social" class="text-center">
			
			<a href="https://linkedin.com"><i class="fa fa-linkedin fa-2x"></i></a>
			<a href="https://github.com/qwding"><i class="fa fa-github fa-2x"></i></a>
			<a href="mailto:edcapding@gmail.com"><i class="fa fa-envelope-o fa-2x"></i></a>
		</div>
		<div id="links" class="text-center">
			
			
				<a href="http://blog.qwding.com/about">About</a>
			
				<a href="http://blog.qwding.com/post/">Blog</a>
			
				<a href="http://blog.qwding.com/persional/">Persional</a>
			
				<a href="http://blog.qwding.com/relax/">Relax</a>
			
		</div>
	</div>
</div>
		<div id="content" class="col-xs-12 col-sm-8 col-md-9">
			<div class="row">
				<div id="post" class="col-sm-offset-1 col-sm-10 col-md-10 col-lg-8">

<main>
	<header>
		<h1>portus的docker容器搭建</h1>
	</header>
	
	<article>
		

<h3 id="一般形式:95f2626a8b71aea78c26d5a625e37de7">一般形式</h3>

<p>在官方文档，或者百度谷歌，搜到的portus一般都是compose形式搭建，这样好处是操作无脑</p>

<p>但是一般情况下我们肯定是自己要更灵活一些的，肯定用docker容器形式更舒服一点。可是去dockerhub一搜，各种版本的镜像，查看dockerfile很多人都自己加了一些内容，对于不会ruby的人来说，并不知道那些操作都说干啥的。</p>

<h3 id="自己研究研究:95f2626a8b71aea78c26d5a625e37de7">自己研究研究</h3>

<p>github master分支上有dockerfile，如下</p>

<pre><code>FROM library/rails:4.2.2
MAINTAINER Flavio Castelli &lt;fcastelli@suse.com&gt;

ENV COMPOSE=1
EXPOSE 3000

WORKDIR /portus
COPY Gemfile* ./
RUN bundle install --retry=3

# Install phantomjs, this is required for testing and development purposes
# There are no official deb packages for it, hence we built it inside of the
# open build service.
RUN echo &quot;deb http://download.opensuse.org/repositories/home:/flavio_castelli:/phantomjs/Debian_8.0/ ./&quot; &gt;&gt; /etc/apt/sources.list
RUN wget http://download.opensuse.org/repositories/home:/flavio_castelli:/phantomjs/Debian_8.0/Release.key &amp;&amp; \
  apt-key add Release.key &amp;&amp; \
  rm Release.key
RUN apt-get update &amp;&amp; \
    apt-get install -y --no-install-recommends phantomjs &amp;&amp; \
    rm -rf /var/lib/apt/lists/*

ADD . .
</code></pre>

<p>于是直接用那个dockerfile直接build一个镜像。参考别人给出的一些docker run参数启动，并成功了。</p>

<pre><code>docker run -d -e RAILS_ENV=production \
	-e RACK_ENV=production \
	-e PORTUS_SECRET_KEY_BASE=secret-goes-here \
	-e PORTUS_KEY_PATH=/certs/server-key.pem \
	-e PORTUS_PASSWORD=portuspw \
	-e PORTUS_CHECK_SSL_USAGE_ENABLED=false \
	-e PORTUS_MACHINE_FQDN_VALUE=192.168.56.101 \
	-e PORTUS_PRODUCTION_HOST=192.168.56.101 \
	-e PORTUS_PRODUCTION_USERNAME=portus \
	-e PORTUS_PRODUCTION_PASSWORD=portus \
	-e PORTUS_PRODUCTION_DATABASE=portus \
	-v /sslkeys:/certs \
	-v /root/terminal/Portus/:/portus \
	--restart=always \
	-p 5001:3000 portus:v1 puma -b tcp://0.0.0.0:3000 -w 3
</code></pre>

<p>解释一下这些参数</p>

<ul>
<li>PORTUS_SECRET_KEY_BASE 是rails 4.0以后出的一个web安全参数，一般要rake secret生成一个很长很长的随机串，发现随意写个串也无妨。</li>
<li>PORTUS_KEY_PATH 猜测是对应registry给出那个crt的。</li>
<li>PORTUS_PASSWORD 这个参数有意思。在你创建好portus后，需要创建一个用户叫 portus。密码就是这个密码。这个用户的目的是为了同步镜像用的。（之后说）</li>
<li>PORTUS_CHECK_SSL_USAGE_ENABLED 因为我没有官方签发证书，所以用http，如果https，在registry的notifications时候会发不过去。</li>
<li>PORTUS_MACHINE_FQDN_VALUE 就是你的portus要配置的域名。</li>
<li>PORTUS_PRODUCTION_HOST，PORTUS_PRODUCTION_USERNAME，PORTUS_PRODUCTION_PASSWORD，PORTUS_PRODUCTION_DATABASE这几个就是数据库的地址，帐号，密码，数据库</li>
<li>puma -b tcp://0.0.0.0:3000 -w 3 是执行的CMD，试了一下，这个镜像默认是什么都不执行的，所以启动可以添加这个命令，如果不想每次加可以在dockerfile里加上CMD.</li>
</ul>

<h3 id="简化一下:95f2626a8b71aea78c26d5a625e37de7">简化一下</h3>

<p>显然，如上启动方式跟了一大堆参数是很烦的，也不是你想的。当然那就把它们放到配置文件里。</p>

<p>主要有三个配置文件都放在了 Portus/config 文件夹下。分别为 config.yml, database.yml, secrets.yml</p>

<p>将几个env变量都可以配置到文件的production里。</p>

<p>值得注意的是，PORTUS_MACHINE_FQDN_VALUE这个变量在2.0.3版本里是放在了secrets.yml 里，但是如果你用的是portus的master分支，最新的代码是放在config.yml里的。一坑。</p>

<p>所以启动方式可以改成：</p>

<pre><code>docker run -d \
	-e RAILS_ENV=production \
	-e RACK_ENV=production \
	-v /sslkeys:/certs \
	-v /root/terminal/Portus/:/portus \
	-p 5001:3000 \
	--restart=always \
	portus:v1 puma -b tcp://0.0.0.0:3000 -w 3
</code></pre>

<p>不同版本有的参数配置不太一样，参数调整好以后就可以出现登录页面了。就可以开始操作了。</p>

<h3 id="镜像同步:95f2626a8b71aea78c26d5a625e37de7">镜像同步</h3>

<p>两种方法： 一段时间同步一次。每次push操作更新一次。</p>

<ul>
<li>一段时间同步一次</li>
</ul>

<p>在我们登录以后，点击admin选项，会出现红色提示，user portus not exist。这时候你可以先创建portus用户，密码为secrets.yml里填写的密码。这个用户的作用就是同步时候用这个用户当做默认用户同步。</p>

<p>我们在容器里路径为 /Portus 运行 <code>RAILS_ENV=production CATALOG_CRON=&quot;60.seconds&quot; bundle exec crono</code> 他就会每隔60秒，用用户portus请求一次registry的 /v2/_catalog这个api查阅所有镜像。我们查看portus 容器日志会收到这个用户发来的请求。</p>

<p>如果你发现同步失败，请检查是否给了portus admin权限，只有admin权限portus才可以访问所有镜像。</p>

<p>如果想让这个作为单独容器来同步，可以将命令写成个脚本放到portus镜像里 /crono.sh。然后启动容器时候把命令改成 ./crono.sh就行。</p>

<ul>
<li>每次push请求一次</li>
</ul>

<p>就是registry 里配置了 notifications，每次push会来向notifications配置的地址发请求。portus server收到请求后来更改数据库。</p>

<h3 id="问题:95f2626a8b71aea78c26d5a625e37de7">问题</h3>

<ol>
<li><p>本地配置好以后，想试试域名访问有没有问题，结果改成域名以后一直401。</p>

<p>后来突然想到，在登录第一次就配置了regitry server信息。应该是这个server名字改变了，所以拒绝了访问。</p>

<p>修复方法： 直接到数据库的registry表将地址改成域名就行。</p></li>

<li><p>2.0.3版本可以登录，但是还是401. 应该是rails的不同版本的bundle不一样吧，没找解决办法。还是直接改回了master版本。</p></li>

<li><p>push镜像的时候报错：</p>

<pre><code>Error parsing HTTP response: invalid character '&lt;' looking for beginning of value: &quot;&lt;html&gt;\r\n&lt;head&gt;&lt;title&gt;413 Request Entity Too Large&lt;/title&gt;&lt;/head&gt;\r\n&lt;body bgcolor=\&quot;white\&quot;&gt;\r\n&lt;center&gt;&lt;h1&gt;413 Request Entity Too Large&lt;/h1&gt;&lt;/center&gt;\r\n&lt;hr&gt;&lt;center&gt;nginx/1.9.14&lt;/center&gt;\r\n&lt;/body&gt;\r\n&lt;/html&gt;\r\n&quot;
</code></pre></li>
</ol>

<p>这个问题是因为我们使用了http，并配置了nginx，但是默认只有https才允许有basic auth，所以认证失败了。换成https就行。</p>

<p>issue地址：<a href="https://github.com/docker/docker-registry/issues/298#issuecomment-39845868">https://github.com/docker/docker-registry/issues/298#issuecomment-39845868</a></p>

	</article>
</main>

<div id="bottom-nav" class="text-center center-block">
	<a href=" http://blog.qwding.com/" class="btn btn-default"><i class="fa fa-home"></i> Home</a>
</div>


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'puppy';
    var disqus_identifier = 'http:\/\/blog.qwding.com\/post\/portus\/';
    var disqus_title = 'portus的docker容器搭建';
    var disqus_url = 'http:\/\/blog.qwding.com\/post\/portus\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


						</div>
					</div>
				</div>
			</div>
		</div>
  </div>
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-76467136-1', 'auto');
    ga('send', 'pageview');
    window.baseURL = "http:\/\/blog.qwding.com\/";
  </script>
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.2/js/bootstrap.min.js"></script>
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
  
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/highlight.min.js"></script>
  
  <script src="http://blog.qwding.com//js/App.js"></script>
  
  <script type="text/javascript">
  $(function(){
     var url =  $('.fixlink').attr('href');
     url = url.replace(/\/$/,'.md');
     $('.fixlink').attr('href',url);
  });

   </script>
</body>
</html>
